<!DOCTYPE html>
<html>
<head>
  <title>API çŠ¶æ€æµ‹è¯•é¢æ¿</title>
  <meta charset="UTF-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
      background: #0a0a0a;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #4a90e2;
      margin-bottom: 20px;
      font-size: 28px;
    }
    h2 {
      color: #6aa3e8;
      margin: 20px 0 10px 0;
      font-size: 20px;
    }
    h3 {
      color: #8ab4ea;
      margin: 15px 0 10px 0;
      font-size: 16px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    button:hover {
      background: #357abd;
      transform: translateY(-1px);
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    button.success {
      background: #4caf50;
    }
    button.success:hover {
      background: #388e3c;
    }
    .section {
      margin: 15px 0;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .card {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 6px;
      border-left: 3px solid #4a90e2;
    }
    .card.success {
      border-left-color: #4caf50;
    }
    .card.error {
      border-left-color: #f44336;
    }
    .card.warning {
      border-left-color: #ff9800;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status.success {
      background: #4caf50;
      color: white;
    }
    .status.error {
      background: #f44336;
      color: white;
    }
    .status.pending {
      background: #ff9800;
      color: white;
    }
    .status.idle {
      background: #666;
      color: white;
    }
    .log {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .log-line {
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
    }
    .log-line.info {
      color: #4a90e2;
    }
    .log-line.success {
      color: #4caf50;
    }
    .log-line.error {
      color: #f44336;
    }
    .log-line.warning {
      color: #ff9800;
    }
    pre {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 12px;
      margin: 10px 0;
      border: 1px solid #333;
    }
    .item {
      margin: 10px 0;
      padding: 12px;
      background: #2a2a2a;
      border-radius: 6px;
      border-left: 3px solid #4a90e2;
    }
    .item.enabled {
      border-left-color: #4caf50;
    }
    .item.disabled {
      border-left-color: #666;
      opacity: 0.6;
    }
    .item strong {
      color: #4a90e2;
      font-size: 14px;
    }
    .item small {
      color: #999;
      display: block;
      margin-top: 5px;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    .badge.enabled {
      background: #4caf50;
      color: white;
    }
    .badge.disabled {
      background: #666;
      color: white;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin: 15px 0;
    }
    .stat {
      background: #2a2a2a;
      padding: 15px 20px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #4a90e2;
    }
    .stat-label {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
      text-transform: uppercase;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-top-color: #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ API çŠ¶æ€æµ‹è¯•é¢æ¿</h1>

    <div class="toolbar">
      <button onclick="runAllTests()" id="run-all-btn">
        ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•
      </button>
      <button onclick="checkDatabase()" class="success">
        ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“
      </button>
      <button onclick="testConfigAPI()">
        ğŸ“¡ æµ‹è¯•é…ç½® API
      </button>
      <button onclick="checkStore()">
        ğŸ“¦ æ£€æŸ¥ Store çŠ¶æ€
      </button>
      <button onclick="initializeDefaults()" class="warning">
        ğŸ”„ åˆå§‹åŒ–é»˜è®¤é…ç½®
      </button>
      <button onclick="clearLogs()" class="danger">
        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
      </button>
    </div>

    <!-- API Status Overview -->
    <div class="section">
      <h2>ğŸ“Š API çŠ¶æ€æ¦‚è§ˆ</h2>
      <div class="grid">
        <div class="card" id="db-status">
          <h3>æ•°æ®åº“è¿æ¥ <span class="status idle">å¾…æµ‹è¯•</span></h3>
          <div id="db-status-content">æœªæµ‹è¯•</div>
        </div>
        <div class="card" id="api-status">
          <h3>é…ç½® API <span class="status idle">å¾…æµ‹è¯•</span></h3>
          <div id="api-status-content">æœªæµ‹è¯•</div>
        </div>
        <div class="card" id="store-status">
          <h3>Zustand Store <span class="status idle">å¾…æµ‹è¯•</span></h3>
          <div id="store-status-content">æœªæµ‹è¯•</div>
        </div>
      </div>
    </div>

    <!-- Statistics -->
    <div class="section">
      <h2>ğŸ“ˆ é…ç½®ç»Ÿè®¡</h2>
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="stat-edit-options">-</div>
          <div class="stat-label">Edit Look Options</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-templates">-</div>
          <div class="stat-label">Style Templates</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-db-records">-</div>
          <div class="stat-label">DB Records</div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="section">
      <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
      <div class="log" id="log-output">
        <div class="log-line info">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹...</div>
      </div>
    </div>

    <!-- Edit Look Options -->
    <div class="section">
      <h2>ğŸ“¸ Edit Look Options <span id="edit-options-count"></span></h2>
      <div id="edit-options-content">
        <p style="color: #999;">æœªåŠ è½½ï¼Œè¯·è¿è¡Œæµ‹è¯•</p>
      </div>
    </div>

    <!-- Style Templates -->
    <div class="section">
      <h2>ğŸ¨ Aesthetic Style Templates <span id="templates-count"></span></h2>
      <div id="templates-content">
        <p style="color: #999;">æœªåŠ è½½ï¼Œè¯·è¿è¡Œæµ‹è¯•</p>
      </div>
    </div>

    <!-- Raw Data -->
    <div class="section">
      <h2>ğŸ” åŸå§‹æ•°æ®ï¼ˆJSONï¼‰</h2>
      <h3>Looking Config</h3>
      <pre id="raw-looking-data">æœªåŠ è½½</pre>
      <h3>Templates Config</h3>
      <pre id="raw-templates-data">æœªåŠ è½½</pre>
    </div>
  </div>

  <script type="module">
    import { supabase } from './src/services/supabaseClient.js';
    import { supabaseApi } from './src/services/supabaseApi.js';
    import { configService } from './src/services/configService.js';
    import useAppStore from './src/stores/appStore.js';

    let logCount = 0;

    function log(message, type = 'info') {
      const logOutput = document.getElementById('log-output');
      const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
      const timestamp = new Date().toLocaleTimeString();
      logOutput.innerHTML += `<div class="log-line ${type}">[${timestamp}] ${icon} ${message}</div>`;
      logOutput.scrollTop = logOutput.scrollHeight;
      console.log(`[${type}] ${message}`);
      logCount++;
    }

    function updateStatus(cardId, status, content) {
      const card = document.getElementById(cardId);
      const statusSpan = card.querySelector('.status');
      statusSpan.className = `status ${status}`;
      statusSpan.textContent = status === 'success' ? 'æ­£å¸¸' : status === 'error' ? 'é”™è¯¯' : status === 'pending' ? 'æµ‹è¯•ä¸­' : 'å¾…æµ‹è¯•';

      const contentDiv = document.getElementById(`${cardId}-content`);
      contentDiv.innerHTML = content;

      if (status === 'success') {
        card.classList.add('success');
        card.classList.remove('error', 'warning');
      } else if (status === 'error') {
        card.classList.add('error');
        card.classList.remove('success', 'warning');
      }
    }

    window.clearLogs = function() {
      document.getElementById('log-output').innerHTML = '<div class="log-line info">æ—¥å¿—å·²æ¸…ç©º</div>';
      logCount = 0;
    };

    window.runAllTests = async function() {
      const btn = document.getElementById('run-all-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';

      clearLogs();
      log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');

      await checkDatabase();
      await new Promise(r => setTimeout(r, 500));
      await testConfigAPI();
      await new Promise(r => setTimeout(r, 500));
      await checkStore();

      log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
      btn.disabled = false;
      btn.innerHTML = 'ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•';
    };

    window.checkDatabase = async function() {
      log('========== æ•°æ®åº“æ£€æŸ¥ ==========', 'info');
      updateStatus('db-status', 'pending', 'æ£€æŸ¥ä¸­...');

      try {
        // Check table exists
        log('æ£€æŸ¥ prompt_config è¡¨...');
        const { data: tableCheck, error: tableError } = await supabase
          .from('prompt_config')
          .select('count')
          .limit(0);

        if (tableError) {
          log(`è¡¨è®¿é—®é”™è¯¯: ${tableError.message}`, 'error');
          updateStatus('db-status', 'error', `é”™è¯¯: ${tableError.message}`);
          return;
        }

        log('âœ“ è¡¨å­˜åœ¨ä¸”å¯è®¿é—®', 'success');

        // Get all records
        const { data: allRecords, error: queryError } = await supabase
          .from('prompt_config')
          .select('*');

        if (queryError) {
          log(`æŸ¥è¯¢é”™è¯¯: ${queryError.message}`, 'error');
          updateStatus('db-status', 'error', `é”™è¯¯: ${queryError.message}`);
          return;
        }

        const recordCount = allRecords?.length || 0;
        log(`æ‰¾åˆ° ${recordCount} æ¡è®°å½•`, recordCount > 0 ? 'success' : 'warning');
        document.getElementById('stat-db-records').textContent = recordCount;

        if (recordCount === 0) {
          log('âš ï¸ æ•°æ®åº“ä¸ºç©ºï¼Œéœ€è¦åˆå§‹åŒ–', 'warning');
          updateStatus('db-status', 'error', 'æ•°æ®åº“ä¸ºç©ºï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–é»˜è®¤é…ç½®"');
          return;
        }

        // Check specific configs
        const lookingRecord = allRecords.find(r => r.config_type === 'looking');
        const templatesRecord = allRecords.find(r => r.config_type === 'templates');

        let statusHtml = `<div style="margin-top: 10px;">`;

        if (lookingRecord) {
          const editOptionsCount = Object.keys(lookingRecord.config_data?.edit_options || {}).length;
          statusHtml += `<div>âœ… Looking: ${editOptionsCount} ä¸ªé€‰é¡¹</div>`;
          log(`âœ“ Looking é…ç½®: ${editOptionsCount} ä¸ªé€‰é¡¹`, 'success');
        } else {
          statusHtml += `<div>âŒ Looking: ä¸å­˜åœ¨</div>`;
          log('âœ— Looking é…ç½®ä¸å­˜åœ¨', 'error');
        }

        if (templatesRecord) {
          const templatesCount = Object.keys(templatesRecord.config_data?.templates || {}).length;
          statusHtml += `<div>âœ… Templates: ${templatesCount} ä¸ªæ¨¡æ¿</div>`;
          log(`âœ“ Templates é…ç½®: ${templatesCount} ä¸ªæ¨¡æ¿`, 'success');
        } else {
          statusHtml += `<div>âŒ Templates: ä¸å­˜åœ¨</div>`;
          log('âœ— Templates é…ç½®ä¸å­˜åœ¨', 'error');
        }

        statusHtml += `</div>`;

        updateStatus('db-status', 'success', statusHtml);
        log('æ•°æ®åº“æ£€æŸ¥å®Œæˆ', 'success');

      } catch (error) {
        log(`æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        updateStatus('db-status', 'error', `é”™è¯¯: ${error.message}`);
      }
    };

    window.testConfigAPI = async function() {
      log('========== é…ç½® API æµ‹è¯• ==========', 'info');
      updateStatus('api-status', 'pending', 'æµ‹è¯•ä¸­...');

      try {
        // Test looking config
        log('æµ‹è¯• getPromptConfig("looking")...');
        const lookingConfig = await supabaseApi.getPromptConfig('looking');
        const editOptions = lookingConfig.edit_options || {};
        const editOptionsCount = Object.keys(editOptions).length;

        log(`âœ“ æˆåŠŸåŠ è½½ ${editOptionsCount} ä¸ª Edit Look é€‰é¡¹`, 'success');
        document.getElementById('stat-edit-options').textContent = editOptionsCount;

        // Check for realistic or style_id_001
        const hasRealistic = !!editOptions.realistic;
        const hasStyleId001 = !!editOptions.style_id_001;

        if (hasRealistic) {
          log('âœ“ æ‰¾åˆ° realistic é…ç½®ï¼', 'success');
        } else if (hasStyleId001) {
          log('âœ“ æ‰¾åˆ° style_id_001 é…ç½®', 'success');
        } else {
          log('âš ï¸ æœªæ‰¾åˆ° realistic æˆ– style_id_001', 'warning');
        }

        // Display edit options
        const sortedOptions = Object.values(editOptions).sort((a, b) => (a.order || 0) - (b.order || 0));
        let html = '';
        sortedOptions.forEach((option, index) => {
          const enabledClass = option.enabled ? 'enabled' : 'disabled';
          const enabledBadge = option.enabled ? '<span class="badge enabled">å¯ç”¨</span>' : '<span class="badge disabled">ç¦ç”¨</span>';
          html += `
            <div class="item ${enabledClass}">
              <strong>${index + 1}. ${option.name}</strong>${enabledBadge}<br>
              <small>ID: ${option.id}</small><br>
              <small>Prompt: ${option.prompt}</small>
            </div>
          `;
        });
        document.getElementById('edit-options-content').innerHTML = html;
        document.getElementById('edit-options-count').innerHTML = `<span class="status success">${editOptionsCount} ä¸ª</span>`;
        document.getElementById('raw-looking-data').textContent = JSON.stringify(lookingConfig, null, 2);

        // Test templates config
        log('æµ‹è¯• getPromptConfig("templates")...');
        const templatesConfig = await supabaseApi.getPromptConfig('templates');
        const templates = templatesConfig.templates || {};
        const templatesCount = Object.keys(templates).length;

        log(`âœ“ æˆåŠŸåŠ è½½ ${templatesCount} ä¸ªæ¨¡æ¿`, 'success');
        document.getElementById('stat-templates').textContent = templatesCount;

        // Display templates
        const sortedTemplates = Object.values(templates).sort((a, b) => (a.order || 0) - (b.order || 0));
        html = '';
        sortedTemplates.forEach((template, index) => {
          html += `
            <div class="item enabled">
              <strong>${index + 1}. ${template.name}</strong><br>
              <small>ID: ${template.id}</small><br>
              <small>Image: ${template.image || 'N/A'}</small><br>
              <small>Prompt: ${template.prompt}</small>
            </div>
          `;
        });
        document.getElementById('templates-content').innerHTML = html;
        document.getElementById('templates-count').innerHTML = `<span class="status success">${templatesCount} ä¸ª</span>`;
        document.getElementById('raw-templates-data').textContent = JSON.stringify(templatesConfig, null, 2);

        updateStatus('api-status', 'success', `
          <div style="margin-top: 10px;">
            <div>âœ… Edit Options: ${editOptionsCount}</div>
            <div>âœ… Templates: ${templatesCount}</div>
          </div>
        `);
        log('é…ç½® API æµ‹è¯•å®Œæˆ', 'success');

      } catch (error) {
        log(`é…ç½® API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateStatus('api-status', 'error', `é”™è¯¯: ${error.message}`);

        // Show fallback data
        log('âš ï¸ API å¤±è´¥ï¼Œæ˜¾ç¤º JSON fallback æ•°æ®', 'warning');
        document.getElementById('edit-options-content').innerHTML = '<div class="card error">API åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“é…ç½®</div>';
        document.getElementById('templates-content').innerHTML = '<div class="card error">API åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“é…ç½®</div>';
      }
    };

    window.checkStore = async function() {
      log('========== Zustand Store æ£€æŸ¥ ==========', 'info');
      updateStatus('store-status', 'pending', 'æ£€æŸ¥ä¸­...');

      try {
        const state = useAppStore.getState();

        log(`é…ç½®å·²åŠ è½½: ${state.configLoaded}`, state.configLoaded ? 'success' : 'warning');

        if (state.configError) {
          log(`é…ç½®é”™è¯¯: ${state.configError}`, 'error');
        }

        const transformationPrompts = state.transformationPrompts;
        const styleTemplates = state.styleTemplates;

        if (transformationPrompts) {
          const count = Object.keys(transformationPrompts).length;
          log(`âœ“ Store ä¸­æœ‰ ${count} ä¸ª Edit Options`, 'success');
        } else {
          log('âš ï¸ Store ä¸­æ²¡æœ‰ transformationPrompts', 'warning');
        }

        if (styleTemplates) {
          const count = Object.keys(styleTemplates).length;
          log(`âœ“ Store ä¸­æœ‰ ${count} ä¸ª Templates`, 'success');
        } else {
          log('âš ï¸ Store ä¸­æ²¡æœ‰ styleTemplates', 'warning');
        }

        const statusHtml = `
          <div style="margin-top: 10px;">
            <div>${state.configLoaded ? 'âœ…' : 'âŒ'} é…ç½®å·²åŠ è½½: ${state.configLoaded}</div>
            <div>${transformationPrompts ? 'âœ…' : 'âŒ'} Transformation Prompts: ${transformationPrompts ? Object.keys(transformationPrompts).length : 0}</div>
            <div>${styleTemplates ? 'âœ…' : 'âŒ'} Style Templates: ${styleTemplates ? Object.keys(styleTemplates).length : 0}</div>
            ${state.configError ? `<div>âš ï¸ é”™è¯¯: ${state.configError}</div>` : ''}
          </div>
        `;

        updateStatus('store-status', state.configLoaded && transformationPrompts && styleTemplates ? 'success' : 'error', statusHtml);
        log('Store æ£€æŸ¥å®Œæˆ', 'success');

      } catch (error) {
        log(`Store æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        updateStatus('store-status', 'error', `é”™è¯¯: ${error.message}`);
      }
    };

    window.initializeDefaults = async function() {
      log('========== åˆå§‹åŒ–é»˜è®¤é…ç½® ==========', 'info');

      const confirmed = confirm('ç¡®å®šè¦åˆå§‹åŒ–é»˜è®¤é…ç½®å—ï¼Ÿ\n\nè¿™å°†ï¼š\n1. ä» JSON æ–‡ä»¶è¯»å–é…ç½®\n2. å†™å…¥åˆ° Supabase æ•°æ®åº“\n3. è¦†ç›–ç°æœ‰é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰');

      if (!confirmed) {
        log('ç”¨æˆ·å–æ¶ˆåˆå§‹åŒ–', 'warning');
        return;
      }

      try {
        log('è°ƒç”¨ configService.initializeDefaults()...');
        await configService.initializeDefaults();
        log('âœ… åˆå§‹åŒ–æˆåŠŸï¼', 'success');

        log('é‡æ–°åŠ è½½åº”ç”¨é…ç½®...');
        const loadConfig = useAppStore.getState().loadConfigFromSupabase;
        await loadConfig();
        log('âœ… åº”ç”¨é…ç½®å·²åˆ·æ–°', 'success');

        log('é‡æ–°è¿è¡Œæµ‹è¯•...', 'info');
        setTimeout(() => {
          runAllTests();
        }, 1000);

      } catch (error) {
        log(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        alert(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
      }
    };

    // Expose to window
    window.log = log;
    window.updateStatus = updateStatus;
  </script>
</body>
</html>
